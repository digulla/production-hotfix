package de.pdark.tutorial.hotfix.branch1_commit2;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import org.hibernate.SessionFactory;
import org.springframework.beans.factory.annotation.Autowired;
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...

public class Order {
    /*
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    */
    @Autowired
    private String dburl;
    @Autowired
    private String dbuser;
    @Autowired
    private String dbpassword;
    @Autowired
    private SessionFactory sessionFactory;
    
    // ... lots of code omitted ...
    
    // Commit 2: Add TODOs for everything that should be fixed.
    // This helps to distinguish between the bug that we're currently working on
    // and "this should really be fixed ... but not RIGHT NOW".
    // Again easy for the reviewer: Just check that only comments were added.
    public List<OrderItem> collectOrder(User user, long orderId) throws SQLException {
        // TODO APP-3467 Check why Hibernate is not used here. Maybe a deadlock or something?
        //  Safe: Replace with StatelessSession and doReturningWork().
        //  Delete obsolete @Autowired fields.
        Connection conn = DriverManager.getConnection(dburl, dbuser, dbpassword);
        
        // TODO APP-3467 Replace with try-resource
        // TODO APP-3467 Name the columns that we need to make sure we get the columns in a known order.
        PreparedStatement stmt = conn.prepareStatement("select * from orders where orderId = ?");
        stmt.setLong(1, orderId);
        
        // TODO APP-3467 Replace with try-resource
        ResultSet rs = stmt.executeQuery();
        List<OrderItem> orderItems = new ArrayList<>();
        while (rs.next()) {
            // TODO APP-3467 Get column no. by name outside of loop
            String name = rs.getString(1);

            // TODO APP-3467 Replace with try-resource
            // TODO APP-3467 Name the columns that we need to make sure we get the columns in a known order.
            PreparedStatement stmt2 = conn.prepareStatement("select * from articles");
            // TODO APP-3467 Replace with try-resource
            ResultSet rs2 = stmt2.executeQuery();
            
            // TODO APP-3467 Load prizes into lookup map outside of loop. 
            //  Check if there is a bean for this table and use it. 
            //  Consider using Hibernate to load the beans; see above! 
            boolean found = false;
            double amount = 0;
            while (rs2.next()) {
                // TODO APP-3467 Get column no. by name outside of loop
                if (rs2.getString(2).equals(name)) {
                    // TODO APP-3467 Get column no. by name outside of loop
                    amount = rs.getDouble(3);
                    found = true;
                }
            }

            if (found) {
                orderItems.add(new OrderItem(name, (long)(amount*100)));
            }
            // TODO APP-3467 Log error when found == false
            
            rs2.close();
            stmt2.close();
        }
        
        rs.close();
        stmt.close();
        conn.close();
        
        return orderItems;
    }























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    public void foo() {        
        //... code deleted ...
        sessionFactory.getCurrentSession();
        //... code deleted ...
        
        
    }

}
