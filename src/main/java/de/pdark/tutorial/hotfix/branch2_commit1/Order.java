package de.pdark.tutorial.hotfix.branch2_commit1;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.hibernate.SessionFactory;
import org.springframework.beans.factory.annotation.Autowired;
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...
//import ...

public class Order {
    /*
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    @Autowired
    private ...;
    */
    @Autowired
    private String dburl;
    @Autowired
    private String dbuser;
    @Autowired
    private String dbpassword;
    @Autowired
    private SessionFactory sessionFactory;
    
    // ... lots of code omitted ...
    
    // New branch, commit 1: Use our current knowledge to fix another low risk, high return issue.
    //
    // In this case, we have a loop that loads the same data from database for
    // every order item. Instead, load all prices in advance.
    // This is a new branch since it's not low risk.
    // This is because of two facts:
    //
    // 1. We couldn't use an IDE refactoring to extract the code.
    // 2. We don't have a unit test for the extracted code.
    //
    // There is a good chance that the code review will reject this change.
    // But it's not urgent since it's not related to the production issue.
    // That is why it's a good candidate for the development branch where it
    // can mature for the next release. Or the branch can simply be deleted
    // if the team isn't comfortable with this.
    public List<OrderItem> collectOrder(User user, long orderId) throws SQLException {
        // TODO APP-3467 Check why Hibernate is not used here. Maybe a deadlock or something?
        //  Safe: Replace with StatelessSession and doReturningWork().
        //  Delete obsolete @Autowired fields.
        Connection conn = DriverManager.getConnection(dburl, dbuser, dbpassword);
        
        Map<String, Double> priceLookup = loadPrices(conn);
        
        // TODO APP-3467 Replace with try-resource 
        // TODO APP-3467 Name the columns that we need to make sure we get the columns in a known order.
        PreparedStatement stmt = conn.prepareStatement("select * from orders where orderId = ?");
        stmt.setLong(1, orderId);
        
        // TODO APP-3467 Replace with try-resource
        ResultSet rs = stmt.executeQuery();
        List<OrderItem> orderItems = new ArrayList<>();
        while (rs.next()) {
            // TODO APP-3467 Get column no. by name outside of loop
            String name = rs.getString(1);
            Double amount = priceLookup.get(name);

            if (amount != null) {
                orderItems.add(new OrderItem(name, UIAmount.toUI(amount)));
            }
            // TODO APP-3467 Log error when found == false
        }
        
        rs.close();
        stmt.close();
        conn.close();
        
        return orderItems;
    }        
    
    private Map<String, Double> loadPrices(Connection conn) throws SQLException {
        Map<String, Double> result = new HashMap<>();
        
        // TODO APP-3467 Replace with try-resource
        PreparedStatement stmt2 = conn.prepareStatement("select name, amount from articles");
        // TODO APP-3467 Replace with try-resource
        ResultSet rs2 = stmt2.executeQuery();
        
        while (rs2.next()) {
            String name = rs2.getString(1);
            double amount = rs2.getDouble(2);
            result.put(name, amount);
        }

        rs2.close();
        stmt2.close();
        
        return result;
    }
























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    public void foo() {        
        //... code deleted ...
        sessionFactory.getCurrentSession();
        //... code deleted ...
        
        
    }

}
